# AI é©—è­‰ç¨‹å¼ç¢¼çµæ§‹èªªæ˜

## ğŸ“ æª”æ¡ˆçµæ§‹

```
project_root/
â”œâ”€â”€ run_prompt2_gemini.py       # ä¸»ç¨‹å¼ï¼ˆå·²é‡æ§‹ï¼‰
â”œâ”€â”€ temp_data/
â”‚   â”œâ”€â”€ prompt1_json/           # P1 è¼¸å…¥ç›®éŒ„
â”‚   â”‚   â””â”€â”€ {year}_{code}_p1.json
â”‚   â””â”€â”€ prompt2_json/           # P2 è¼¸å‡ºç›®éŒ„
â”‚       â””â”€â”€ {year}_{code}_p2.json
â”œâ”€â”€ news_search/
â”‚   â””â”€â”€ news_output/            # æ–°èè¼¸å…¥ç›®éŒ„
â”‚       â””â”€â”€ {year}_{code}_news.json
â””â”€â”€ static/data/
    â””â”€â”€ msci_flag.json          # MSCI æ¨™æº–
```

---

## ğŸ”§ run_prompt2_gemini.py æ¨¡çµ„çµæ§‹

### 1. æ¨¡çµ„å°å…¥èˆ‡åˆå§‹åŒ– (L1-17)

```python
import json, os, re, tiktoken, time
import pandas as pd
from dotenv import load_dotenv
from google import genai
from google.genai import types

# è¼‰å…¥ç’°å¢ƒè®Šæ•¸
load_dotenv()
api_key = os.getenv("GEMINI_API_KEY")

# åˆå§‹åŒ– Gemini Client
client = genai.Client(api_key=api_key)

# Token ç·¨ç¢¼å™¨ï¼ˆç”¨æ–¼ä¼°ç®—ï¼‰
enc = tiktoken.get_encoding("cl100k_base")
```

---

### 2. Token ä¼°ç®—å·¥å…· (L19-22)

#### estimate_tokens()
```python
def estimate_tokens(text: str) -> int:
    """ä¼°ç®—æ–‡å­—çš„ Token æ•¸é‡"""
    if not text:
        return 0
    return len(enc.encode(text))
```

**ç”¨é€”**ï¼š
- ä¼°ç®— Prompt é•·åº¦
- è¨ˆç®— API æˆæœ¬
- é¡¯ç¤ºä½¿ç”¨çµ±è¨ˆ

---

### 3. æ ¸å¿ƒé©—è­‰å‡½æ•¸ process_esg_news_verification() (L25-327)

#### å‡½æ•¸ç°½å

```python
def process_esg_news_verification(
    input_json_path,      # P1.json è·¯å¾‘
    news_json_path,       # æ–°è.json è·¯å¾‘
    msci_json_path,       # MSCI æ¨™æº–è·¯å¾‘
    output_json_path      # P2.json è¼¸å‡ºè·¯å¾‘
) -> Dict:
    """
    è™•ç† ESG æ–°èé©—è­‰
    
    Returns:
        {
            'success': bool,
            'processed_items': int,
            'input_tokens': int,
            'output_tokens': int,
            'total_tokens': int,
            'api_time': float,
            'total_time': float
        }
    """
```

#### åŸ·è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è®€å–ä¸‰å€‹è¼¸å…¥æª”æ¡ˆ     â”‚
â”‚  - P1 JSON (åŸå§‹åˆ†æ)  â”‚
â”‚  - æ–°è JSON           â”‚
â”‚  - MSCI æ¨™æº–           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ§‹å»º Prompt         â”‚
â”‚  - åµŒå…¥æª”æ¡ˆå…§å®¹        â”‚
â”‚  - è¨­å®šè¼¸å‡ºæ ¼å¼è¦æ±‚    â”‚
â”‚  - å¼·èª¿æ¬„ä½åç¨±è¦ç¯„    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ä¼°ç®—è¼¸å…¥ Token      â”‚
â”‚  - Prompt Template     â”‚
â”‚  - User Input          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å‘¼å« Gemini API     â”‚
â”‚  - Model: gemini-2.5-proâ”‚
â”‚  - Temperature: 0      â”‚
â”‚  - Format: JSON        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. è§£æ JSON å›æ‡‰      â”‚
â”‚  - ç§»é™¤ Markdown æ¨™è¨˜  â”‚
â”‚  - æå– JSON é™£åˆ—      â”‚
â”‚  - å¤šé‡è§£æç­–ç•¥        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. å„²å­˜çµæœèˆ‡çµ±è¨ˆ      â”‚
â”‚  - å¯«å…¥ P2.json        â”‚
â”‚  - è¿”å›çµ±è¨ˆè³‡è¨Š        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4. Prompt è¨­è¨ˆ (L67-147)

#### é—œéµéƒ¨åˆ†

**1. è¼¸å‡ºæ ¼å¼è¦æ±‚ï¼ˆå·²ä¿®æ­£ï¼‰**
```python
# é‡è¦ï¼šä¿æŒæ¬„ä½åç¨±ä¸€è‡´æ€§
é‡è¦ï¼šè«‹ä¿æŒåŸæª”æ¬„ä½åç¨±ä¸è®Šï¼Œç‰¹åˆ¥æ˜¯ï¼š
- **company** å¿…é ˆç¶­æŒåŸæª”çš„è‚¡ç¥¨ä»£è™Ÿæ ¼å¼ï¼ˆä¾‹å¦‚ "1101"ï¼‰ï¼Œä¸è¦è½‰æ›ç‚ºå…¬å¸åç¨±
- **report_claim** æ¬„ä½åç¨±ç¶­æŒä¸è®Šï¼Œä¸è¦æ”¹ç‚º disclosure_claim

è¼¸å‡ºç¯„ä¾‹ï¼š
**company**: "1101",  # å¿…é ˆæ˜¯ä»£è™Ÿ
**report_claim**: "...",  # ç¶­æŒæ­¤æ¬„ä½åç¨±
```

**2. MSCI Flag åˆ¤æ–·é‚è¼¯**
```python
æ‰£åˆ†æ©Ÿåˆ¶ï¼šred = -4, orange = -2, yellow = -1, green = 0
adjustment_score = risk_score + æ‰£åˆ†
```

**3. ç›¸é—œæ€§æª¢æŸ¥**
```python
# å¦‚æœæ–°èèˆ‡å…¬å¸ç„¡é—œã€ä¸»é¡Œä¸ç¬¦ã€ç„¡æ–°è
consistency_status: "ä¸€è‡´"
external_evidence: "ç„¡ç›¸é—œæ–°èè­‰æ“š"
external_evidence_url: ""
MSCI_flag: "Green"
adjustment_score: (ç¶­æŒåŸ risk_score)
```

---

### 5. JSON è§£æç­–ç•¥ (L185-282)

#### å¤šé‡è§£ææ–¹æ³•

```python
# æ–¹æ³• 1: ç§»é™¤ markdown ä»£ç¢¼å¡Š
if raw_text.startswith("```json"):
    clean_text = re.sub(r'^```(?:json)?\s*\n?', '', raw_text)
    clean_text = re.sub(r'\n?```\s*$', '', clean_text)
    final_json = json.loads(clean_text.strip())

# æ–¹æ³• 2: æ­£å‰‡æå– JSON ä»£ç¢¼å¡Š
json_match = re.search(r'```(?:json)?\s*(\[.*?\])\s*```', raw_text, re.DOTALL)

# æ–¹æ³• 3: ç›´æ¥æŸ¥æ‰¾ JSON é™£åˆ—
all_arrays = re.findall(r'(\[.*\])', raw_text, re.DOTALL)

# æ–¹æ³• 4: æ‹¬è™Ÿè¨ˆæ•¸æ³•ï¼ˆä¿®å¾©æ¨¡å¼ï¼‰
start = raw_text.find('[')
count = 0
for i in range(start, len(raw_text)):
    if raw_text[i] == '[': count += 1
    elif raw_text[i] == ']': count -= 1
    if count == 0:
        end_pos = i + 1
        break
```

---

### 6. æ¨¡çµ„åŒ–æ¥å£ verify_esg_with_news() (L330-459)

#### å‡½æ•¸ç°½å

```python
def verify_esg_with_news(
    year: int,
    company_code: str,
    force_regenerate: bool = False
) -> Dict[str, Any]:
    """
    æ¨¡çµ„åŒ–æ¥å£ï¼šåŸ·è¡Œ ESG æ–°èé©—è­‰èˆ‡è©•åˆ†èª¿æ•´
    
    Returns:
        {
            'success': bool,
            'message': str,
            'output_path': str,
            'skipped': bool,
            'statistics': {...},
            'error': str  # è‹¥å¤±æ•—
        }
    """
```

#### åŸ·è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è‡ªå‹•æ§‹å»ºè·¯å¾‘         â”‚
â”‚  â”œâ”€ P1: temp_data/prompt1_json/{year}_{code}_p1.json
â”‚  â”œâ”€ æ–°è: news_search/news_output/{year}_{code}_news.json
â”‚  â”œâ”€ MSCI: static/data/msci_flag.json
â”‚  â””â”€ P2: temp_data/prompt2_json/{year}_{code}_p2.json
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æª”æ¡ˆå­˜åœ¨æ€§æª¢æŸ¥       â”‚ â† force_regenerate=False
â”‚  - P2 å·²å­˜åœ¨ï¼Ÿ         â”‚
â”‚  - æ ¼å¼æ­£ç¢ºï¼Ÿ          â”‚
â”‚  - Yes: return skipped â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ No
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æª¢æŸ¥å¿…è¦è¼¸å…¥æª”æ¡ˆ     â”‚
â”‚  - P1.json å­˜åœ¨ï¼Ÿ      â”‚
â”‚  - æ–°è.json å­˜åœ¨ï¼Ÿ    â”‚
â”‚  - MSCI.json å­˜åœ¨ï¼Ÿ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ All exist
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. åŸ·è¡Œ AI é©—è­‰        â”‚
â”‚  - å‘¼å« process_esg_news_verification()
â”‚  - ç²å–çµ±è¨ˆè³‡è¨Š        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. é©—è­‰è¼¸å‡ºæª”æ¡ˆ        â”‚
â”‚  - P2.json ç”¢ç”Ÿï¼Ÿ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. è¿”å›çµæœèˆ‡çµ±è¨ˆ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 7. å‘½ä»¤åˆ—åŸ·è¡Œå…¥å£ (L462-470)

```python
if __name__ == "__main__":
    input_path = './temp_data/prompt1_json/2024_1102_p1.json'
    news_path = './news_search/news_output/2024_1102_news.json'
    msci_path = './static/data/msci_flag.json'
    output_path = './temp_data/prompt2_json/2024_1102_p2.json'
    
    process_esg_news_verification(input_path, news_path, msci_path, output_path)
```

---

## ğŸ”„ è³‡æ–™æµ

### å®Œæ•´åŸ·è¡Œæµç¨‹

```
ä½¿ç”¨è€…èª¿ç”¨
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ verify_esg_with_news()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
      P2 æª”æ¡ˆå·²å­˜åœ¨ï¼Ÿ
         â†™   â†˜
      Yes    No
       â†“      â†“
    è·³é    æª¢æŸ¥è¼¸å…¥æª”æ¡ˆ
    è¿”å›      â†“
          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
          P1  æ–°è  MSCI
          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
               â†“
   process_esg_news_verification()
               â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
        â†“             â†“
    è®€å–è³‡æ–™      æ§‹å»º Prompt
        â†“             â†“
    å‘¼å« Gemini    è§£æå›æ‡‰
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
               â†“
           å„²å­˜ P2.json
               â†“
           è¿”å›çµ±è¨ˆè³‡è¨Š
```

---

## ğŸ“Š è³‡æ–™çµæ§‹

### è¼¸å…¥

**P1 JSONï¼š**
```json
[
  {
    "company": "1101",
    "year": "2024",
    "esg_category": "E",
    "sasb_topic": "æº«å®¤æ°£é«”æ’æ”¾",
    "page_number": "20",
    "report_claim": "...",
    "greenwashing_factor": "...",
    "risk_score": 4
  }
]
```

**æ–°è JSONï¼š**
```json
[
  {
    "news_id": 1,
    "stock_code": "1102",
    "company_name": "äºæ³¥",
    "sasb_topic": "æº«å®¤æ°£é«”æ’æ”¾",
    "title": "...",
    "url": "...",
    "published_date": "2024-05-15",
    "publisher": "é‰…äº¨ç¶²"
  }
]
```

**MSCI æ¨™æº–ï¼š**
```json
{
  "Environment": {
    "Red": "å¤§è¦æ¨¡ç”Ÿæ…‹æµ©åŠ«",
    "Orange": "é‡å¤§é•è¦ä½†å¯æ§",
    "Yellow": "åè¦†ç™¼ç”Ÿçš„åˆè¦å•é¡Œ",
    "Green": "ç„¡é‡å¤§è£ç½°"
  }
}
```

### è¼¸å‡º

**å‡½æ•¸å›å‚³æ ¼å¼ï¼š**
```python
{
    'success': True,
    'message': 'AI é©—è­‰å®Œæˆ',
    'output_path': 'temp_data/prompt2_json/2024_1102_p2.json',
    'skipped': False,
    'statistics': {
        'processed_items': 26,
        'input_tokens': 18523,
        'output_tokens': 9842,
        'total_tokens': 28365,
        'api_time': 45.23,
        'total_time': 46.12
    }
}
```

**P2 JSON æ ¼å¼ï¼š**
```json
[
  {
    "company": "1101",
    "year": "2024",
    "esg_category": "E",
    "sasb_topic": "æº«å®¤æ°£é«”æ’æ”¾",
    "page_number": "20",
    "report_claim": "...",
    "greenwashing_factor": "...",
    "risk_score": 4,
    "external_evidence": "...",
    "external_evidence_url": "...",
    "consistency_status": "éƒ¨åˆ†ç¬¦åˆ",
    "msci_flag": "Green",
    "adjustment_score": 4
  }
]
```

---

## ğŸ›¡ï¸ éŒ¯èª¤è™•ç†

### ç•°å¸¸æ•ç²å±¤ç´š

| å±¤ç´š | å‡½æ•¸ | è™•ç†æ–¹å¼ |
|------|------|---------|
| **æª”æ¡ˆè®€å–** | process_esg_news_verification | è¿”å› {'success': False, 'error': ...} |
| **API å‘¼å«** | process_esg_news_verification | è¿”å›éŒ¯èª¤è¨Šæ¯ |
| **JSON è§£æ** | process_esg_news_verification | å¤šé‡ç­–ç•¥è§£æï¼Œå¤±æ•—å‰‡å„²å­˜ debug æª”æ¡ˆ |
| **æª”æ¡ˆé©—è­‰** | verify_esg_with_news | æª¢æŸ¥è¼¸å…¥æª”æ¡ˆå­˜åœ¨æ€§ |
| **é€šç”¨ç•°å¸¸** | verify_esg_with_news | æ•ç²æ‰€æœ‰ç•°å¸¸ä¸¦è¿”å›çµ±ä¸€æ ¼å¼ |

### éŒ¯èª¤è¨Šæ¯ç¤ºä¾‹

```python
# ç¼ºå°‘è¼¸å…¥æª”æ¡ˆ
{
    'success': False,
    'message': 'ç¼ºå°‘å¿…è¦è¼¸å…¥æª”æ¡ˆ',
    'error': 'P1 æª”æ¡ˆ: ./temp_data/prompt1_json/2024_1102_p1.json'
}

# API å‘¼å«å¤±æ•—
{
    'success': False,
    'error': 'API call failed: ...'
}

# JSON è§£æå¤±æ•—
{
    'success': False,
    'message': 'JSON è§£æå¤±æ•—',
    'error': 'Expecting value: line 1 column 1 (char 0)'
}
```

---

## ğŸ“ è¨­è¨ˆæ¨¡å¼

### 1. è·è²¬åˆ†é›¢
- `estimate_tokens()`: Token ä¼°ç®—
- `process_esg_news_verification()`: æ ¸å¿ƒé©—è­‰é‚è¼¯
- `verify_esg_with_news()`: æ¨¡çµ„åŒ–æ¥å£ï¼ˆæª”æ¡ˆç®¡ç†ã€éŒ¯èª¤è™•ç†ï¼‰

### 2. é˜²ç¦¦æ€§ç·¨ç¨‹
- å¤šé‡ JSON è§£æç­–ç•¥
- è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
- Debug æª”æ¡ˆå„²å­˜

### 3. çµ±è¨ˆå›å ±
- Token ä½¿ç”¨é‡
- åŸ·è¡Œæ™‚é–“
- è™•ç†é …ç›®æ•¸

---

## ğŸ”‘ é—œéµè¨­è¨ˆæ±ºç­–

### 1. ç‚ºä»€éº¼ä¿®æ­£ Promptï¼Ÿ
- **å•é¡Œ**ï¼šåŸ Prompt å°è‡´æ¬„ä½ä¸ä¸€è‡´ï¼ˆcompany ç‚ºå…¬å¸åç¨±ï¼‰
- **è§£æ±º**ï¼šæ˜ç¢ºè¦æ±‚ä¿æŒ P1 æ ¼å¼
- **å½±éŸ¿**ï¼šç¢ºä¿è³‡æ–™åº«å°æ‡‰æ­£ç¢º

### 2. ç‚ºä»€éº¼ä½¿ç”¨å¤šé‡è§£æç­–ç•¥ï¼Ÿ
- Gemini API å›æ‡‰æ ¼å¼ä¸ç©©å®š
- å¯èƒ½åŒ…å« markdown ä»£ç¢¼å¡Š
- æé«˜è§£ææˆåŠŸç‡

### 3. ç‚ºä»€éº¼è¿”å›çµ±è¨ˆè³‡è¨Šï¼Ÿ
- ç›£æ§ API æˆæœ¬
- æä¾›åŸ·è¡Œåé¥‹
- ä¾¿æ–¼å•é¡Œè¨ºæ–·

### 4. ç‚ºä»€éº¼æª”æ¡ˆå­˜åœ¨æ€§æª¢æŸ¥ï¼Ÿ
- é¿å…é‡è¤‡ API å‘¼å«
- ç¯€çœæˆæœ¬ï¼ˆæ¯æ¬¡ ~25K tokensï¼‰
- æé«˜åŸ·è¡Œæ•ˆç‡

---

**æ–‡æª”ç‰ˆæœ¬ï¼š** 1.0  
**æœ€å¾Œæ›´æ–°ï¼š** 2026-01-15
