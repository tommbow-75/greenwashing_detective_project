<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESG 綠洗風險監測儀表板</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>
</head>

<body>
    <div class="header">
        <h1>🌱 ESG 綠色洗白風險監測儀表板</h1>
        <p>表面很綠，底下見真章</p>
    </div>

    <div class="container">
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label>🔍 公司代碼</label>
                    <input type="text" id="searchInput" placeholder="請輸入公司代碼（如 2330）...">
                </div>
                <div class="filter-group">
                    <label>🏢 產業別</label>
                    <select id="industryFilter">
                        <option value="">全部產業</option>
                        <option value="水泥工業">水泥工業</option>
                        <option value="食品工業">食品工業</option>
                        <option value="塑膠工業">塑膠工業</option>
                        <option value="紡織纖維">紡織纖維</option>
                        <option value="電機機械">電機機械</option>
                        <option value="電器電纜">電器電纜</option>
                        <option value="化學工業">化學工業</option>
                        <option value="生技醫療業">生技醫療業</option>
                        <option value="玻璃陶瓷">玻璃陶瓷</option>
                        <option value="造紙工業">造紙工業</option>
                        <option value="鋼鐵工業">鋼鐵工業</option>
                        <option value="橡膠工業">橡膠工業</option>
                        <option value="汽車工業">汽車工業</option>
                        <option value="半導體業">半導體業</option>
                        <option value="電腦及週邊設備業">電腦及週邊設備業</option>
                        <option value="光電業">光電業</option>
                        <option value="通信網路業">通信網路業</option>
                        <option value="電子零組件業">電子零組件業</option>
                        <option value="電子通路業">電子通路業</option>
                        <option value="資訊服務業">資訊服務業</option>
                        <option value="其他電子業">其他電子業</option>
                        <option value="建材營造">建材營造</option>
                        <option value="航運業">航運業</option>
                        <option value="觀光餐旅">觀光餐旅</option>
                        <option value="金融保險業">金融保險業</option>
                        <option value="貿易百貨">貿易百貨</option>
                        <option value="油電燃氣業">油電燃氣業</option>
                        <option value="綜合企業">綜合企業</option>
                        <option value="綠能環保">綠能環保</option>
                        <option value="數位雲端">數位雲端</option>
                        <option value="運動休閒">運動休閒</option>
                        <option value="居家生活">居家生活</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>📅 年度</label>
                    <select id="yearFilter">
                        <option value="">全部年度</option>
                        <option value="2024" selected>2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                    </select>
                </div>
                <button class="btn" id="searchButton" style="margin-top: 1.5rem;">🔎 搜尋</button>
            </div>
        </div>

        <div id="initialPrompt" class="initial-prompt" style="margin-top: 2rem;">
            <div class="prompt-content">
                <img src="{{ url_for('static', filename='images/harvesting-tools.gif') }}" alt="搜尋提示動圖"
                    class="prompt-gif">
                <p class="prompt-text">請使用上方篩選條件進行搜尋，以查看 ESG 綠洗風險監測結果</p>
            </div>
        </div>

        <!-- 狀態顯示區域 -->
        <div id="statusDisplay" class="status-display" style="margin-top: 2rem; display: none;">
            <div id="statusContent" class="status-content"></div>
        </div>

        <div id="resultsDashboard" class="results-dashboard" style="margin-top: 2rem; display: none;">
            <div class="table-responsive">
                <table class="dashboard-table"
                    style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); min-width: 800px;">
                    <thead style="background: var(--primary); color: white;">
                        <tr>
                            <th style="padding: 1rem;">公司名稱</th>
                            <th style="padding: 1rem;">股票代號</th>
                            <th style="padding: 1rem;">產業別</th>
                            <th style="padding: 1rem;">年份</th>
                            <th style="padding: 1rem;">總風險</th>
                            <th style="padding: 1rem;">E風險</th>
                            <th style="padding: 1rem;">S風險</th>
                            <th style="padding: 1rem;">G風險</th>
                            <th style="padding: 1rem;">操作</th>
                        </tr>
                    </thead>
                    <tbody id="companiesContainer">
                    </tbody>
                </table>
            </div>
            <div id="paginationControls" class="pagination-controls" style="margin-top: 1rem; display: none;">
                <button id="prevPage" class="btn" style="padding: 0.5rem 1rem; margin-right: 0.5rem;">上一頁</button>
                <span id="pageInfo" style="margin: 0 1rem; color: var(--text-secondary);"></span>
                <button id="nextPage" class="btn" style="padding: 0.5rem 1rem;">下一頁</button>
            </div>
        </div>

        <div id="detailView" class="detail-view">
            <div class="detail-view-header">
                <h2 id="detailCompanyName">公司詳細分析</h2>
                <button class="close-detail" onclick="closeDetail()">✕</button>
            </div>

            <div id="filterHint"
                style="background: rgba(32, 128, 128, 0.05); padding: 1rem; border-radius: 6px; margin-bottom: 2rem; display: none;">
                <p style="color: var(--primary); font-weight: 600;">篩選模式已啟用：只顯示 <span id="filterFieldName"></span> 領域資料
                </p>
                <button class="btn" style="padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="clearFilter()">取消篩選 -
                    顯示全部</button>
            </div>

            <div id="layer4" class="analysis-section">
                <h3 class="section-title">🔍 第四層：內部比對 </h3>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">分析報告內容與實際績效的一致性</p>
                <div class="table-responsive">
                    <table class="comparison-table" style="min-width: 600px;">
                        <thead>
                            <tr>
                                <th width="10%">esg_category</th>
                                <th width="20%">sasb_topic</th>
                                <th width="8%">page_number</th>
                                <th width="20%">report_claim</th>
                                <th width="15%">greenwashing_factor</th>
                                <th width="12%">risk_score</th>
                            </tr>
                        </thead>
                        <tbody id="layer4Table">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="layer5" class="analysis-section hidden">
                <h3 class="section-title">📰 第五層：外部新聞揭露對比</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">對標外部新聞與監管文件的一致性</p>
                <div class="table-responsive">
                    <table class="comparison-table" style="min-width: 600px;">
                        <thead>
                            <tr>
                                <th>esg_category</th>
                                <th>report_claim</th>
                                <th>external_evidence</th>
                                <th>consistency_status</th>
                                <th>MSCI_flag</th>
                                <th>adjustment_score</th>
                            </tr>
                        </thead>
                        <tbody id="layer5Table">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="layer6" class="analysis-section hidden">
                <h3 class="section-title">⚖️ 第六層：SASB 產業權重分布 (Materiality Map)</h3>
                <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">依據 SASB 標準，<span
                        style="font-weight:bold; color:var(--primary);">深色區塊</span> 代表該產業的重大議題 (權重 x 2)，<span
                        style="color:var(--text-secondary);">淺色區塊</span> 為一般議題 (權重 x 1)</p>
                <div id="sasbInfo"
                    style="margin-top: 1rem; padding: 10px; background: rgba(0,0,0,0.02); border-radius: 4px; font-size: 0.9rem; color: var(--text-secondary); text-align: center;">
                </div>
                <div class="sasb-grid" id="sasbContainer">
                </div>
            </div>

            <div id="layer7" class="analysis-section">
                <h3 class="section-title">☁️ 第七層：關鍵字出現頻率 (詞雲)</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">報告中出現頻率最高的 ESG 相關詞彙（字體越大＝頻率越高）</p>
                <div class="wordcloud-container">
                    <div class="wordcloud" id="wordcloudArea">
                    </div>
                </div>
            </div>
        </div>

        <div id="layer8" class="analysis-section">
            <h3 class="section-title">
                📊 第八層：參考資料
                <button
                    style="margin-left: 10px; padding: 5px; font-size: 1.2rem; border: none; background: transparent; cursor: pointer; color: var(--text-secondary); line-height: 1;"
                    onclick="var el=document.getElementById('layer8Content'); el.classList.toggle('collapsed'); this.innerText = el.classList.contains('collapsed') ? '▶' : '▼';">
                    ▼
                </button>
            </h3>
            <span id="layer8Content" class="source-grid">
                <div class="source-card">
                    <div class="source-title">📰 資料來源</div>
                    <ul class="source-list" style="font-size: 14px;">
                        <li><a href="https://www.sciencedirect.com/science/article/abs/pii/S0361368207000451"
                                target="_blank" rel="noopener noreferrer">Clarkson et al. (2008) 模型</a></li>
                        <li><a href="https://www.ares-registration.com/?sub=services&cat=esg&item=AA1000#gsc.tab=0"
                                target="_blank" rel="noopener noreferrer">AA1000 AP 2018 當責性原則標準</a></li>
                        <li><a href="https://www.ardf.org.tw/html/opinion/au/3000.pdf" target="_blank"
                                rel="noopener noreferrer">國際確信準則 3000 號</a></li>
                        <li><a href="https://www.globalreporting.org/standards/" target="_blank"
                                rel="noopener noreferrer">GRI八大原則</a></li>
                        <li><a href="https://www.investopedia.com/sustainability-accounting-standards-board-7484327"
                                target="_blank" rel="noopener noreferrer">SASB 標準</a></li>
                        <li><a href="https://www.msci.com/downloads/web/msci-com/data-and-analytics/sustainability-solutions/MSCI%20ESG%20Government%20Ratings%20Methodology.pdf"
                                target="_blank" rel="noopener noreferrer">MSCI ESG 政府評分方法論</a></li>
                        <li><a href="https://www.metzler.com/downloads/Metzler/Download-Dokumente-MAM/Nachhaltigkeit/MAM-MSCI-ESG-Controversies-and-Global-Norms-Methodology.pdf"
                                target="_blank" rel="noopener noreferrer">MSCI ESG 樣板方法論</a></li>
                    </ul>
                </div>
            </span>
        </div>

        <div id="layer9" class="analysis-section" style="box-shadow: none; background: transparent; padding: 0;">
            <div style="padding: 1rem; border-top: 1px solid #e2e8f0;">
                <p style="color: #94a3b8; font-size: 0.85rem; line-height: 1.5; text-align: center;">
                    免責聲明：本平台之分析結果僅供學術研究與初步篩選參考，並非專業投資建議。所有數據來源均為公開資訊，本團隊已盡力確保資料正確性，但無法保證其絕對無誤。使用者在參考本平台資訊進行任何決策前，請務必自行查證或諮詢專業人士。
                </p>
                <p
                    style="color: #94a3b8; font-size: 0.85rem; line-height: 1.5; text-align: center; margin-top: 0.5rem;">
                    © 2024 Greenwashing Detective. All Rights Reserved.
                    本網站之所有內容（包括但不限於文字、圖表、程式碼及演算法）均受智慧財產權法保護，未經授權不得重製、散布或用於商業用途。
                </p>
            </div>
        </div>

        <!-- 從 Flask 傳入的 JSON 資料，先以純 JSON 形式嵌入，避免與 JS 語法衝突 -->
        <script id="companies-data" type="application/json">
        {{ companies | tojson | safe }}
    </script>

        <script>
            // 讀取並解析後端嵌入的 JSON 資料
            const companiesData = JSON.parse(
                document.getElementById("companies-data").textContent || "[]"
            );

            // 圖片基礎路徑 (給 script.js 使用，目前沒用到)
            const imgBasePath = "{{ url_for('static', filename='images/') }}";

            // SASB JSON 路徑
            const sasbJsonPath = "{{ url_for('static', filename='data/SASB_weightMap.json') }}";

            console.log("資料庫已載入:", companiesData.length, "筆公司資料");
        </script>

        <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>

</html>