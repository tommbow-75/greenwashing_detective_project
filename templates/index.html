<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESG 綠洗風險監測儀表板</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <div class="header">
        <h1>🌱 ESG 綠色洗白風險監測儀表板</h1>
        <p>表面很綠，底下見真章</p>
    </div>

    <div class="container">
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label>🔍 公司名稱</label>
                    <input type="text" id="searchInput" placeholder="公司名稱...">
                </div>
                <div class="filter-group">
                    <label>🏢 產業別</label>
                    <select id="industryFilter">
                        <option value="">全部產業</option>
                        <option value="水泥工業">水泥工業</option>
                        <option value="食品工業">食品工業</option>
                        <option value="塑膠工業">塑膠工業</option>
                        <option value="紡織纖維">紡織纖維</option>
                        <option value="電機機械">電機機械</option>
                        <option value="電器電纜">電器電纜</option>
                        <option value="化學工業">化學工業</option>
                        <option value="生技醫療業">生技醫療業</option>
                        <option value="玻璃陶瓷">玻璃陶瓷</option>
                        <option value="造紙工業">造紙工業</option>
                        <option value="鋼鐵工業">鋼鐵工業</option>
                        <option value="橡膠工業">橡膠工業</option>
                        <option value="汽車工業">汽車工業</option>
                        <option value="半導體業">半導體業</option>
                        <option value="電腦及週邊設備業">電腦及週邊設備業</option>
                        <option value="光電業">光電業</option>
                        <option value="通信網路業">通信網路業</option>
                        <option value="電子零組件業">電子零組件業</option>
                        <option value="電子通路業">電子通路業</option>
                        <option value="資訊服務業">資訊服務業</option>
                        <option value="其他電子業">其他電子業</option>
                        <option value="建材營造">建材營造</option>
                        <option value="航運業">航運業</option>
                        <option value="觀光餐旅">觀光餐旅</option>
                        <option value="金融保險業">金融保險業</option>
                        <option value="貿易百貨">貿易百貨</option>
                        <option value="油電燃氣業">油電燃氣業</option>
                        <option value="綜合企業">綜合企業</option>
                        <option value="綠能環保">綠能環保</option>
                        <option value="數位雲端">數位雲端</option>
                        <option value="運動休閒">運動休閒</option>
                        <option value="居家生活">居家生活</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>📅 年度</label>
                    <select id="yearFilter">
                        <option value="">全部年度</option>
                        <option value="2024" selected>2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                    </select>
                </div>
                <button class="btn" id="searchButton" style="margin-top: 1.5rem;">🔎 搜尋</button>
            </div>
        </div>

        <div id="initialPrompt" class="initial-prompt" style="margin-top: 2rem;">
            <div class="prompt-content">
                <img src="{{ url_for('static', filename='images/harvesting-tools.gif') }}" alt="搜尋提示動圖"
                    class="prompt-gif">
                <p class="prompt-text">請使用上方篩選條件進行搜尋，以查看 ESG 綠洗風險監測結果</p>
            </div>
        </div>

        <div id="resultsDashboard" class="results-dashboard" style="margin-top: 2rem; display: none;">
            <table class="dashboard-table"
                style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                <thead style="background: var(--primary); color: white;">
                    <tr>
                        <th style="padding: 1rem;">公司名稱</th>
                        <th style="padding: 1rem;">股票代號</th>
                        <th style="padding: 1rem;">產業別</th>
                        <th style="padding: 1rem;">年份</th>
                        <th style="padding: 1rem;">總風險</th>
                        <th style="padding: 1rem;">E風險</th>
                        <th style="padding: 1rem;">S風險</th>
                        <th style="padding: 1rem;">G風險</th>
                        <th style="padding: 1rem;">操作</th>
                    </tr>
                </thead>
                <tbody id="companiesContainer">
                </tbody>
            </table>
            <div id="paginationControls" class="pagination-controls" style="margin-top: 1rem; display: none;">
                <button id="prevPage" class="btn" style="padding: 0.5rem 1rem; margin-right: 0.5rem;">上一頁</button>
                <span id="pageInfo" style="margin: 0 1rem; color: var(--text-secondary);"></span>
                <button id="nextPage" class="btn" style="padding: 0.5rem 1rem;">下一頁</button>
            </div>
        </div>

        <div id="detailView" class="detail-view">
            <div class="detail-view-header">
                <h2 id="detailCompanyName">公司詳細分析</h2>
                <button class="close-detail" onclick="closeDetail()">✕</button>
            </div>

            <div id="filterHint"
                style="background: rgba(32, 128, 128, 0.05); padding: 1rem; border-radius: 6px; margin-bottom: 2rem; display: none;">
                <p style="color: var(--primary); font-weight: 600;">篩選模式已啟用：只顯示 <span id="filterFieldName"></span> 領域資料
                </p>
                <button class="btn" style="padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="clearFilter()">取消篩選 -
                    顯示全部</button>
            </div>

            <div id="layer4" class="analysis-section">
                <h3 class="section-title">🔍 第四層：內部比對 </h3>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">分析報告內容與實際績效的一致性</p>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>esg_category</th>
                            <th>sasb_topic</th>
                            <th>page_number </th>
                            <th>report_claim</th>
                            <th>factor (adjustment)</th>
                            <th>risk_score</th>
                        </tr>
                    </thead>
                    <tbody id="layer4Table">
                    </tbody>
                </table>
            </div>

            <div id="layer5" class="analysis-section hidden">
                <h3 class="section-title">📰 第五層：外部新聞揭露對比</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">對標外部新聞與監管文件的一致性</p>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>esg_category</th>
                            <th>report_claim</th>
                            <th>external_evidence</th>
                            <th>external_evidence_url</th>
                            <th>consistency_status</th>
                            <th>msci_flag</th>
                            <th>adjustment_score</th>

                        </tr>
                    </thead>
                    <tbody id="layer5Table">
                        <tr>
                            <td>E</td>
                            <td>「無重大環保違規」</td>
                            <td>環保署公告2023年罰款3次</td>
                            <td><a href="#">連結</a></td>
                            <td>不一致 ⚠️</td>
                            <td>red</td>
                            <td><span class="risk-label high">高風險</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="layer6" class="analysis-section hidden">
                <h3 class="section-title">⚖️ 第六層：SASB 產業權重分布 (Materiality Map)</h3>
                <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">依據 SASB 標準，<span
                        style="font-weight:bold; color:var(--primary);">深色區塊</span> 代表該產業的重大議題 (權重 x 2)，<span
                        style="color:var(--text-secondary);">淺色區塊</span> 為一般議題 (權重 x 1)</p>
                <div id="sasbInfo"
                    style="margin-top: 1rem; padding: 10px; background: rgba(0,0,0,0.02); border-radius: 4px; font-size: 0.9rem; color: var(--text-secondary); text-align: center;">
                </div>
                <div class="sasb-grid" id="sasbContainer">
                </div>
            </div>

            <div id="layer7" class="analysis-section">
                <h3 class="section-title">☁️ 第七層：關鍵字出現頻率 (詞雲)</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">報告中出現頻率最高的 ESG 相關詞彙（字體越大＝頻率越高）</p>
                <div class="wordcloud-container">
                    <div class="wordcloud" id="wordcloudArea">
                    </div>
                </div>
            </div>

            <div id="layer8" class="analysis-section">
                <h3 class="section-title">📊 第八層：資料來源與驗證</h3>
                <div class="source-grid">
                    <div class="source-card">
                        <div class="source-title">📰 新聞資料來源</div>
                        <ul class="source-list">
                            <li>聯合報 ESG 報導</li>
                            <li>經濟日報企業動態</li>
                            <li>台灣證交所公告</li>
                            <li>環保署新聞稿</li>
                            <li>PTT 看板討論</li>
                            <li>Glassdoor 員工評論</li>
                            <li>新聞爬蟲更新頻率: 每日</li>
                        </ul>
                    </div>
                    <div class="source-card">
                        <div class="source-title">📊 數據資料來源</div>
                        <ul class="source-list">
                            <li>TEJ ESG Database</li>
                            <li>MSCI ESG Rating</li>
                            <li>環保署罰款紀錄</li>
                            <li>公開資訊觀測站</li>
                            <li>Sustainalytics</li>
                            <li>排放量資料來源</li>
                            <li>數據同步: 即時更新</li>
                        </ul>
                    </div>
                    <div class="source-card">
                        <div class="source-title">⏰ 更新與準確性</div>
                        <ul class="source-list">
                            <li>ESG報告更新: 2025/12/17</li>
                            <li>新聞爬蟲: 每日 09:00 更新</li>
                            <li>罰款紀錄: 即時同步</li>
                            <li>排放數據: 季度更新</li>
                            <li>🟢 數據准確率: 95%</li>
                            <li>🟢 模型可信度: 高</li>
                            <li>🟢 信息完整度: 92%</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 從 Flask 傳入的 JSON 資料，先以純 JSON 形式嵌入，避免與 JS 語法衝突 -->
    <script id="companies-data" type="application/json">
        {{ companies | tojson | safe }}
    </script>

    <script>
        // 讀取並解析後端嵌入的 JSON 資料
        const companiesData = JSON.parse(
            document.getElementById("companies-data").textContent || "[]"
        );

        // 圖片基礎路徑 (給 script.js 使用，目前沒用到)
        const imgBasePath = "{{ url_for('static', filename='images/') }}";

        // SASB JSON 路徑
        const sasbJsonPath = "{{ url_for('static', filename='data/SASB_weightMap.json') }}";

        console.log("資料庫已載入:", companiesData.length, "筆公司資料");
    </script>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>

</html>